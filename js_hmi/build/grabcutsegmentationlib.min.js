var GRABCUTSEGMENTATIONLIB=GRABCUTSEGMENTATIONLIB||{REVISION:"1"};GRABCUTSEGMENTATIONLIB.ImageViewer=function(a){console.log(a),a=a||{},this.stage=a.stage,console.log(this.stage),this.bitmap=null,this.src=null,this.srcContext=null,this.srcWidth=0,this.srcHeight=0,this.srcData=null,this.srcPixels=null},GRABCUTSEGMENTATIONLIB.ImageViewer.prototype.__proto__=EventEmitter2.prototype,GRABCUTSEGMENTATIONLIB.ImageViewer.prototype.updateDisplay=function(a){if(console.log("update display"),null!=this.bitmap&&this.stage.removeChild(this.bitmap),"rgb8"!=a.encoding&&"bgr8"!=a.encoding)return console.log("unrecognized image encoding!"),console.log(a.encoding),void 0;var b=a.width,c=a.height,d=window.atob(a.data),e=d.length;if(null==this.src||this.srcWidth!=b||this.srcHeight!=c){var f=document.createElement("div");f.innerHTML='<canvas width="'+b+'" height="'+c+'"></canvas>',this.src=f.firstChild,this.srcContext=this.src.getContext("2d"),this.srcWidth=b,this.srcHeight=c,this.srcData=this.srcContext.getImageData(0,0,this.srcWidth,this.srcHeight),this.srcPixels=this.srcData.data,console.log("created new canvas")}var g=0,h=0;if("rgb8"==a.encoding)for(;e>g;){for(var i=0;3>i;i++)this.srcPixels[h+i]=d.charCodeAt(g+i);this.srcPixels[h+3]=255,g+=3,h+=4}else for(;e>g;)this.srcPixels[h+0]=d.charCodeAt(g+2),this.srcPixels[h+1]=d.charCodeAt(g+1),this.srcPixels[h+2]=d.charCodeAt(g+0),this.srcPixels[h+3]=255,g+=3,h+=4;this.srcContext.putImageData(this.srcData,0,0),this.bitmap=new createjs.Bitmap(this.src),this.stage.addChildAt(this.bitmap,0),this.stage.update()},GRABCUTSEGMENTATIONLIB.BoundingBox=function(a){var b=this;this.stage=a.stage,this.width=a.width,this.height=a.height;var c=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setInterval(a,100)},!1),d=null,e=null;this.bounds=null,this.rect=new createjs.Shape,this.stage.addChild(this.rect);var f=function(a,f){if("down"==f)console.log("mouse down"),console.log(b.stage),c=!0,d={x:a.stageX,y:a.stageY},e=b.stage.globalToRos(a.stageX,a.stageY),positionVec3=new ROSLIB.Vector3(e),b.rect.graphics.clear(),b.stage.update(),b.bounds=null;else if("move"===f){if(c===!0){var g={x:a.stageX,y:a.stageY},h=b.stage.globalToRos(a.stageX,a.stageY);currentPosVec3=new ROSLIB.Vector3(h);var i={x:d.x,y:d.y};d.x>g.x&&(i.x=g.x),d.y>g.y&&(i.y=g.y);var j=Math.abs(d.x-g.x),k=Math.abs(d.y-g.y);b.bounds={x:i.x,y:i.y,dx:j,dy:k},b.rect.graphics.clear().beginStroke("#F00").drawRect(i.x,i.y,j,k),b.stage.update()}}else c=!1};this.stage.addEventListener("stagemousedown",function(a){f(a,"down")}),this.stage.addEventListener("stagemousemove",function(a){f(a,"move")}),this.stage.addEventListener("stagemouseup",function(a){f(a,"up")})},GRABCUTSEGMENTATIONLIB.BoundingBox.prototype.getbounds=function(){return this.rect.graphics.clear(),this.bounds},GRABCUTSEGMENTATIONLIB.BoundingBox.prototype.__proto__=EventEmitter2.prototype,GRABCUTSEGMENTATIONLIB.PixelEditor=function(a){function b(a){var b={u:Math.round(a.stageX),v:Math.round(a.stageY)},c=e.stage.globalToRos(a.stageX,a.stageY);currentPosVec3=new ROSLIB.Vector3(c);var d=new createjs.Point(g.x+a.stageX>>1,g.y+a.stageY>>1);"foreground"===e.label?(console.log("mouse moved! - foreground"),e.foreground.push(b),e.fgLine.graphics.moveTo(d.x,d.y).curveTo(g.x,g.y,h.x,h.y)):"background"===e.label?(console.log("mouse moved! - foreground"),e.background.push(b),e.bgLine.graphics.moveTo(d.x,d.y).curveTo(g.x,g.y,h.x,h.y)):console.log("mouse moved! - no label"),g.x=a.stageX,g.y=a.stageY,h.x=d.x,h.y=d.y,e.stage.update()}function c(a){console.log("down"),f=!0,g=new createjs.Point(a.stageX,a.stageY),h=g,console.log("stage children: ",e.stage.getNumChildren()),e.stage.addEventListener("stagemousemove",b)}function d(){console.log("up"),f=!1,e.stage.removeEventListener("stagemousemove",b)}var e=this;this.stage=a.stage,this.width=a.width,this.height=a.height,this.bitmap=null;var f=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setInterval(a,100)},!1);this.foreground=[],this.background=[],this.fgLine=new createjs.Shape,this.fgLine.graphics.beginStroke("#F00").setStrokeStyle(3,"round"),this.stage.addChild(this.fgLine),this.bgLine=new createjs.Shape,this.bgLine.graphics.beginStroke("#00F").setStrokeStyle(3,"round"),this.stage.addChild(this.bgLine),this.label="none";var g,h;this.stage.addEventListener("stagemousedown",c),this.stage.addEventListener("stagemouseup",d)},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.getlabels=function(){var a={fg:this.foreground,bg:this.background};return this.foreground=[],this.background=[],this.label="none",this.fgLine.graphics.clear(),this.fgLine.graphics.beginStroke("#F00").setStrokeStyle(3,"round"),this.bgLine.graphics.clear(),this.bgLine.graphics.beginStroke("#00F").setStrokeStyle(3,"round"),this.stage.update(),a},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.displayMask=function(a){var b=180,c=0,d=window.atob(a.data),e=document.createElement("canvas"),f=e.getContext("2d");e.width=this.width,e.height=this.height,tempData=f.getImageData(0,0,this.width,this.height),tempPixels=tempData.data,imageIndex=0;for(var g=0;g<d.length;g++){for(var h=0;3>h;h++)tempPixels[imageIndex+h]=0;alpha=1==d.charCodeAt(g)||3==d.charCodeAt(g)?c:b,tempPixels[imageIndex+3]=alpha,imageIndex+=4}console.log(tempPixels),f.putImageData(tempData,0,0),null!=this.bitmap&&this.stage.removeChild(this.bitmap),this.bitmap=new createjs.Bitmap(e),this.stage.addChildAt(this.bitmap,1),this.stage.update()},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.__proto__=EventEmitter2.prototype,GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.setForeground=function(){this.label="foreground"},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.setBackground=function(){this.label="background"},GRABCUTSEGMENTATIONLIB.Segmenter=function(a){var b=this;a=a||{};var c=a.ros,d=(a.host||"localhost",a.bboxService),e=a.editService;this.bboxDiv=$("#"+a.bboxDiv),this.editDiv=$("#"+a.editDiv);var f=a.canvasWidth,g=a.canvasHeight,h="grabcut-bbox-canvas",i="grabcut-edit-canvas",j="grabcut-bbox-canvas-display",k="grabcut-edit-canvas-display";this.bboxDiv.dialog({autoOpen:!1,width:f,height:g}),this.editDiv.dialog({autoOpen:!1,width:f,height:g}),this.bboxDiv.html('<div id="'+h+'"><canvas id ="'+j+'" width = "'+f+'" height="'+g+'"> </canvas></div> <br> <br><button id="grabcut-bbox">Segment</button> <button id="grabcut-reset">Reset</button>'),this.editDiv.html('<div id="'+i+'"><canvas id ="'+k+'" width = "'+f+'" height="'+g+'"> </canvas></div> <br> <br><button id="grabcut-edit">Segment</button> <button id="edit-foreground">Edit Foreground</button> <button id="edit-background">EditBackground</button>');var l=document.getElementById(j);bboxStage=new createjs.Stage(l);var m=new GRABCUTSEGMENTATIONLIB.BoundingBox({stage:bboxStage,width:f,height:g}),n=new GRABCUTSEGMENTATIONLIB.ImageViewer({stage:bboxStage}),o=document.getElementById(k);editStage=new createjs.Stage(o);var p=new GRABCUTSEGMENTATIONLIB.PixelEditor({stage:editStage,width:f,height:g}),q=new GRABCUTSEGMENTATIONLIB.ImageViewer({stage:editStage});this.bboxServer=new ROSLIB.SimpleActionServer({ros:c,serverName:d,actionName:"shared_autonomy_msgs/BoundingBoxAction"}),this.editServer=new ROSLIB.SimpleActionServer({ros:c,serverName:e,actionName:"shared_autonomy_msgs/EditPixelAction"}),this.bboxServer.on("goal",function(a){console.log("bbox service call"),console.log(a),n.updateDisplay(a.image),b.bboxDiv.dialog("open")}),this.editServer.on("goal",function(a){console.log("edit service call"),console.log(a),console.log(editStage),q.updateDisplay(a.image),p.displayMask(a.mask),b.editDiv.dialog("open")}),$("#grabcut-bbox").button().click(function(){console.log("clicked segmentation button - testing");var a=m.getbounds(),c={min_row:{data:Math.round(a.y)},max_row:{data:Math.round(a.y+a.dy)},min_col:{data:Math.round(a.x)},max_col:{data:Math.round(a.x+a.dx)}};b.bboxServer.setSucceeded(c),console.log("... set succeeded with: "),console.log(c),b.bboxDiv.dialog("close")}),$("#grabcut-edit").button().click(function(){console.log("clicked segmentation button - testing");var a=p.getlabels();b.editServer.setSucceeded(a),console.log("... set succeeded with: "),console.log(a),b.editDiv.dialog("close")}),$("#edit-foreground").button().click(function(){console.log("Now editing FG pixels"),p.setForeground()}),$("#edit-background").button().click(function(){console.log("Now editing BG pixels"),p.setBackground()})};