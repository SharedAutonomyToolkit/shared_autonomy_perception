var GRABCUTSEGMENTATIONLIB=GRABCUTSEGMENTATIONLIB||{REVISION:"1"};GRABCUTSEGMENTATIONLIB.ImageViewer=function(a){a=a||{},this.stage=a.stage,this.bitmap=null,this.src=null,this.srcContext=null,this.srcWidth=0,this.srcHeight=0,this.srcData=null,this.srcPixels=null},GRABCUTSEGMENTATIONLIB.ImageViewer.prototype.__proto__=EventEmitter2.prototype,GRABCUTSEGMENTATIONLIB.ImageViewer.prototype.updateDisplay=function(a){if(console.log("update display"),null!=this.bitmap&&this.stage.removeChild(this.bitmap),"rgb8"!=a.encoding&&"bgr8"!=a.encoding)return console.log("unrecognized image encoding!"),void 0;var b=a.width,c=a.height,d=window.atob(a.data),e=d.length;if(null==this.src||this.srcWidth!=b||this.srcHeight!=c){var f=document.createElement("div");f.innerHTML='<canvas width="'+b+'" height="'+c+'"></canvas>',this.src=f.firstChild,this.srcContext=this.src.getContext("2d"),this.srcWidth=b,this.srcHeight=c,this.srcData=this.srcContext.getImageData(0,0,this.srcWidth,this.srcHeight),this.srcPixels=this.srcData.data,console.log("created new canvas")}var g=0,h=0;if("rgb8"==a.encoding)for(;e>g;){for(var i=0;3>i;i++)this.srcPixels[h+i]=d.charCodeAt(g+i);this.srcPixels[h+3]=255,g+=3,h+=4}else for(;e>g;)this.srcPixels[h+0]=d.charCodeAt(g+2),this.srcPixels[h+1]=d.charCodeAt(g+1),this.srcPixels[h+2]=d.charCodeAt(g+0),this.srcPixels[h+3]=255,g+=3,h+=4;this.srcContext.putImageData(this.srcData,0,0),this.bitmap=new createjs.Bitmap(this.src),this.stage.addChildAt(this.bitmap,0),this.stage.update()},GRABCUTSEGMENTATIONLIB.BoundingBox=function(a){var b=this,c=a.stage;this.imageViewer=new GRABCUTSEGMENTATIONLIB.ImageViewer({stage:c});var d=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setInterval(a,100)},!1),e=null;this.bounds=null,this.rect=new createjs.Shape,c.addChild(this.rect);var f=function(a,f){if("down"==f)d=!0,e={x:a.stageX,y:a.stageY},b.rect.graphics.clear(),c.update(),b.bounds=null;else if("move"===f){if(d===!0){var g={x:a.stageX,y:a.stageY},h={x:e.x,y:e.y};e.x>g.x&&(h.x=g.x),e.y>g.y&&(h.y=g.y);var i=Math.abs(e.x-g.x),j=Math.abs(e.y-g.y);b.bounds={x:h.x,y:h.y,dx:i,dy:j},b.rect.graphics.clear().beginStroke("#F00").drawRect(h.x,h.y,i,j),c.update()}}else d=!1};c.addEventListener("stagemousedown",function(a){f(a,"down")}),c.addEventListener("stagemousemove",function(a){f(a,"move")}),c.addEventListener("stagemouseup",function(a){f(a,"up")})},GRABCUTSEGMENTATIONLIB.BoundingBox.prototype.getBounds=function(){var a={min_row:{data:Math.round(this.bounds.y)},max_row:{data:Math.round(this.bounds.y+this.bounds.dy)},min_col:{data:Math.round(this.bounds.x)},max_col:{data:Math.round(this.bounds.x+this.bounds.dx)}};return a},GRABCUTSEGMENTATIONLIB.BoundingBox.prototype.clearBounds=function(){this.rect.graphics.clear(),this.bounds=null},GRABCUTSEGMENTATIONLIB.BoundingBox.prototype.setGoal=function(a){this.imageViewer.updateDisplay(a.image)},GRABCUTSEGMENTATIONLIB.BoundingBox.prototype.__proto__=EventEmitter2.prototype,GRABCUTSEGMENTATIONLIB.PixelEditor=function(a){function b(a){var b={u:Math.round(a.stageX),v:Math.round(a.stageY)},c=new createjs.Point(f.x+a.stageX>>1,f.y+a.stageY>>1);"foreground"===e.label?(e.foreground.push(b),e.fgLine.graphics.moveTo(c.x,c.y).curveTo(f.x,f.y,g.x,g.y)):"background"===e.label&&(e.background.push(b),e.bgLine.graphics.moveTo(c.x,c.y).curveTo(f.x,f.y,g.x,g.y)),f.x=a.stageX,f.y=a.stageY,g.x=c.x,g.y=c.y,e.stage.update()}function c(a){f=new createjs.Point(a.stageX,a.stageY),g=f,e.stage.addEventListener("stagemousemove",b)}function d(){e.stage.removeEventListener("stagemousemove",b)}var e=this;this.stage=a.stage,this.width=a.width,this.height=a.height,this.imageViewer=new GRABCUTSEGMENTATIONLIB.ImageViewer({stage:this.stage}),this.bitmap=null;window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setInterval(a,100)};this.foreground=[],this.background=[],this.fgLine=new createjs.Shape,this.fgLine.graphics.beginStroke("#F00").setStrokeStyle(3,"round"),this.stage.addChild(this.fgLine),this.bgLine=new createjs.Shape,this.bgLine.graphics.beginStroke("#00F").setStrokeStyle(3,"round"),this.stage.addChild(this.bgLine),this.label="none";var f,g;this.stage.addEventListener("stagemousedown",c),this.stage.addEventListener("stagemouseup",d)},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.getLabels=function(){var a={fg:this.foreground,bg:this.background};return a},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.clearLabels=function(){this.foreground=[],this.background=[],this.label="none",this.fgLine.graphics.clear(),this.fgLine.graphics.beginStroke("#F00").setStrokeStyle(3,"round"),this.bgLine.graphics.clear(),this.bgLine.graphics.beginStroke("#00F").setStrokeStyle(3,"round"),this.stage.update()},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.displayMask=function(a){var b=180,c=0;"mono8"!=a.encoding&&console.log("Mask has unrecognized image encoding!");var d=window.atob(a.data),e=document.createElement("canvas"),f=e.getContext("2d");e.width=this.width,e.height=this.height,tempData=f.getImageData(0,0,this.width,this.height),tempPixels=tempData.data,imageIndex=0;for(var g=0;g<d.length;g++){for(var h=0;3>h;h++)tempPixels[imageIndex+h]=0;alpha=1==d.charCodeAt(g)||3==d.charCodeAt(g)?c:b,tempPixels[imageIndex+3]=alpha,imageIndex+=4}f.putImageData(tempData,0,0),null!=this.bitmap&&this.stage.removeChild(this.bitmap),this.bitmap=new createjs.Bitmap(e),this.stage.addChildAt(this.bitmap,1),this.stage.update()},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.__proto__=EventEmitter2.prototype,GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.setGoal=function(a){this.imageViewer.updateDisplay(a.image),this.displayMask(a.mask)},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.setForeground=function(){this.label="foreground"},GRABCUTSEGMENTATIONLIB.PixelEditor.prototype.setBackground=function(){this.label="background"},GRABCUTSEGMENTATIONLIB.Segmenter=function(a){a=a||{};var b=a.ros,c=a.bboxService,d=a.editService,e=$("#"+a.bboxDiv),f=$("#"+a.editDiv),g=a.canvasWidth,h=a.canvasHeight,i="grabcut-bbox-canvas",j="grabcut-edit-canvas",k="grabcut-bbox-canvas-display",l="grabcut-edit-canvas-display";e.dialog({autoOpen:!1,width:g,height:h}),f.dialog({autoOpen:!1,width:g,height:h}),e.html('<div id="'+i+'"><canvas id ="'+k+'" width = "'+g+'" height="'+h+'"> </canvas></div> <br> <br><button id="grabcut-bbox">Segment</button> <button id="grabcut-reset">Reset</button>'),f.html('<div id="'+j+'"><canvas id ="'+l+'" width = "'+g+'" height="'+h+'"> </canvas></div> <br> <br><button id="grabcut-edit">Segment</button> <button id="edit-foreground">Edit Foreground</button> <button id="edit-background">EditBackground</button>');var m=document.getElementById(k);bboxStage=new createjs.Stage(m);var n=new GRABCUTSEGMENTATIONLIB.BoundingBox({stage:bboxStage}),o=document.getElementById(l);editStage=new createjs.Stage(o);var p=new GRABCUTSEGMENTATIONLIB.PixelEditor({stage:editStage,width:g,height:h}),q=new ROSLIB.SimpleActionServer({ros:b,serverName:c,actionName:"shared_autonomy_msgs/BoundingBoxAction"}),r=new ROSLIB.SimpleActionServer({ros:b,serverName:d,actionName:"shared_autonomy_msgs/EditPixelAction"});q.on("goal",function(a){n.setGoal(a),e.dialog("open")}),r.on("goal",function(a){p.setGoal(a),f.dialog("open")}),$("#grabcut-bbox").button().click(function(){var a=n.getBounds();n.clearBounds(),q.setSucceeded(a),e.dialog("close")}),$("#grabcut-edit").button().click(function(){var a=p.getLabels();p.clearLabels(),r.setSucceeded(a),f.dialog("close")}),$("#edit-foreground").button().click(function(){p.setForeground()}),$("#edit-background").button().click(function(){p.setBackground()})};